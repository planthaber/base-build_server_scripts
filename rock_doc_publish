#! /bin/sh -ex

# This script allows to publish documentation generated by rock_doc_all
#
# Its behaviour is modified by the following environment variables:
#   SOURCE_DIR: the directory in which the documentation has been generated
#   TARGET_DIR: the directory in which the documentation should be generated
#   TEMPLATE_DIR: the template directory for the whole published website
#
# It should be provided a set of arguments of the form
#   source_dir:target_dir
#
# where source_dir is one directory relative to SOURCE_DIR
#   and target_dir where it gets copied in TARGET_DIR

set -ex

# Backup original website directory 
if test -d $TARGET_DIR; then
    rsync -r --delete $TARGET_DIR/ $TARGET_DIR-old/
fi

if test -n "$TEMPLATE_DIR"; then
    cp -r $TEMPLATE_DIR $TARGET_DIR
else
    mkdir $TARGET_DIR
fi

for source in "$@"; do
    source_dir=`echo $source | sed 's/:.*//'`
    target_dir=`echo $source | sed 's/.*://'`

    source_path=$SOURCE_DIR/$source_dir

    # Check whether there *is* documentation, and do a quick sanity check
    # - when we don't have a new documentation then fallback to the old one
    if ! ( test -d $source_path/ && test -f $source_path/index.html && test -f $source_path/autoproj_bootstrap ); then
        if test -d $TARGET_DIR-old/$target_dir; then
            source_path=$TARGET_DIR-old/$target_dir
        else
            echo "no data available for $source_dir:$target_dir"
            exit 1
        fi
    fi

    # Extract documentation and api from each flavor to our 'export' 
    # directory 
    rsync -r --delete $source_path/ $TARGET_DIR/$target_dir/
done

# Fix permissions
chmod u=rwX -R ./
chmod go=rX -R ./

# Copy the main documentation first
( cd www; lftp -c "open $TARGET_URL && mirror -R --exclude api ./ www/" )
( cd www; lftp -c "open $TARGET_URL && mirror -R --delete ./ www/" )

